<?xml version="1.0" encoding="UTF-8"?>
<root BTCPP_format="4"
    main_tree_to_execute="UseElevator">
  <BehaviorTree ID="ApproveEntry">
    <DetectDoorOpen/>
  </BehaviorTree>

  <BehaviorTree ID="ApproveExit">
    <Parallel failure_count="1"
              success_count="-1">
      <DetectDoorOpen/>
      <Sequence>
        <RecheckCurrentFloor curr_floor="{curr_floor}"/>
        <IfThenElse _successIf="curr_floor==target_floor"
                    _failureIf="curr_floor!=target_floor">
          <AlwaysFailure/>
        </IfThenElse>
      </Sequence>
    </Parallel>
  </BehaviorTree>

  <BehaviorTree ID="GoPressButtonAndComeBack">
    <AsyncSequence>
      <Timeout msec="1000000000">
        <RetryUntilSuccessful num_attempts="3">
          <Navigate goal_pos="{panel_pos}"
                    initial_pos="{start_pos}"
                    _description="Go to a given location. Return start location"/>
        </RetryUntilSuccessful>
      </Timeout>
      <Timeout msec="1000000000">
        <RetryUntilSuccessful num_attempts="-1">
          <DetectButtonPos button_text="{bt_text}"
                           button_pos="{bt_pos}"/>
        </RetryUntilSuccessful>
      </Timeout>
      <Timeout msec="1000000000">
        <RetryUntilSuccessful num_attempts="3">
          <ManipulateToPose goal_pose="{bt_pos}"/>
        </RetryUntilSuccessful>
      </Timeout>
      <Timeout msec="1000000000">
        <RetryUntilSuccessful num_attempts="3">
          <PressButton/>
        </RetryUntilSuccessful>
      </Timeout>
      <Timeout msec="1000000000">
        <RetryUntilSuccessful num_attempts="3">
          <ManipulateToPose goal_pose="{arm_home_pose}"/>
        </RetryUntilSuccessful>
      </Timeout>
      <Timeout msec="1000000000">
        <RetryUntilSuccessful num_attempts="3">
          <Navigate goal_pos="{start_pos}"
                    initial_pos="{panel_pos}"/>
        </RetryUntilSuccessful>
      </Timeout>
    </AsyncSequence>
  </BehaviorTree>

  <BehaviorTree ID="UseElevator">
    <AsyncSequence>
      <SubTree ID="GoPressButtonAndComeBack"
               panel_pos="{call_panel_pos}"
               bt_text="{call_bt_dir}"
               _autoremap="true"/>
      <SubTree ID="WaitAndEnterElevator"
               _autoremap="true"/>
      <SubTree ID="GoPressButtonAndComeBack"
               panel_pos="{floor_panel_pos}"
               bt_text="{target_floor}"
               _autoremap="true"/>
      <SubTree ID="WaitAndExitElevator"
               _autoremap="true"/>
    </AsyncSequence>
  </BehaviorTree>

  <BehaviorTree ID="WaitAndEnterElevator">
    <AsyncSequence>
      <Timeout msec="1000000000">
        <RetryUntilSuccessful num_attempts="-1">
          <SubTree ID="ApproveEntry" _autoremap="true"/>
        </RetryUntilSuccessful>
      </Timeout>
      <RetryUntilSuccessful num_attempts="3">
        <Fallback>
          <Navigate goal_pos="{floor_panel_pos}"
                    initial_pos="{elevator_entry_pos}"/>
          <Inverter>
            <Timeout msec="1000000000">
              <RetryUntilSuccessful num_attempts="-1">
                <SubTree ID="ApproveEntry" _autoremap="true"/>
              </RetryUntilSuccessful>
            </Timeout>
          </Inverter>
        </Fallback>
      </RetryUntilSuccessful>
      <RecheckCurrentFloor curr_floor="{entry_floor}"/>
    </AsyncSequence>
  </BehaviorTree>

  <BehaviorTree ID="WaitAndExitElevator">
    <AsyncSequence>
      <Timeout msec="1000000000">
        <RetryUntilSuccessful num_attempts="-1">
          <SubTree ID="ApproveExit" _autoremap="true"/>
        </RetryUntilSuccessful>
      </Timeout>
      <RetryUntilSuccessful num_attempts="3">
        <Fallback>
          <Navigate goal_pos="{elevator_exit_pos}"
                    initial_pos="{elev_exit_pos}"/>
          <Inverter>
            <Timeout msec="1000000000">
              <RetryUntilSuccessful num_attempts="-1">
                <SubTree ID="ApproveExit" _autoremap="true"/>
              </RetryUntilSuccessful>
            </Timeout>
          </Inverter>
        </Fallback>
      </RetryUntilSuccessful>
      <RecheckCurrentFloor curr_floor="{exit_floor}"/>
    </AsyncSequence>
  </BehaviorTree>

  <!-- Description of Node Models (used by Groot) -->
  <TreeNodesModel>
    <Action ID="DetectDoorOpen"
            editable="true"/>
    <Action ID="DetectButtonPos"
            editable="true">
      <input_port name="button_text">Which button to press on a panel</input_port>
      <output_port name="button_pos">Pose of button detected</output_port>
    </Action>
    <Action ID="ManipulateToPose"
            editable="true">
      <input_port name="goal_pose"/>
    </Action>
    <Action ID="Navigate"
            editable="true">
      <input_port name="goal_pos">2D position to navigate to</input_port>
      <output_port name="initial_pos">2D position from where the robot started</output_port>
    </Action>
    <Action ID="PressButton"
            editable="true"/>
    <Action ID="RecheckCurrentFloor"
            editable="true">
      <output_port name="curr_floor">Floor Detected</output_port>
    </Action>
  </TreeNodesModel>

</root>
